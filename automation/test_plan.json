{
    "name": "Vera Test and Debug Plan",
    "version": "1.0",
    "steps": [
        {
            "name": "Initial Check",
            "description": "Проверка базового состояния системы",
            "actions": [
                {
                    "type": "command",
                    "name": "Check Docker",
                    "command": "docker --version"
                },
                {
                    "type": "command",
                    "name": "Check Docker Compose",
                    "command": "docker compose version"
                }
            ],
            "checks": [
                {
                    "type": "service_status",
                    "name": "Check PostgreSQL",
                    "service": "postgres"
                },
                {
                    "type": "service_status",
                    "name": "Check Redis",
                    "service": "redis"
                },
                {
                    "type": "service_status",
                    "name": "Check App",
                    "service": "app"
                }
            ]
        },
        {
            "name": "Database Tests",
            "description": "Проверка работы с базой данных",
            "actions": [
                {
                    "type": "command",
                    "name": "Check PostgreSQL Connection",
                    "command": "docker exec vera-postgres psql -U postgres -c 'SELECT version();'"
                },
                {
                    "type": "command",
                    "name": "Check Redis Connection",
                    "command": "docker exec vera-redis redis-cli ping"
                }
            ],
            "checks": [
                {
                    "type": "command",
                    "name": "Check PostgreSQL Tables",
                    "command": "docker exec vera-postgres psql -U postgres -c 'SELECT COUNT(*) FROM information_schema.tables;'"
                },
                {
                    "type": "command",
                    "name": "Check Redis Data",
                    "command": "docker exec vera-redis redis-cli info keyspace"
                }
            ]
        },
        {
            "name": "Service Restart Test",
            "description": "Тестирование перезапуска сервисов",
            "actions": [
                {
                    "type": "command",
                    "name": "Restart PostgreSQL",
                    "command": "docker compose restart postgres"
                },
                {
                    "type": "command",
                    "name": "Restart Redis",
                    "command": "docker compose restart redis"
                },
                {
                    "type": "command",
                    "name": "Restart App",
                    "command": "docker compose restart app"
                }
            ],
            "checks": [
                {
                    "type": "service_status",
                    "name": "Check PostgreSQL After Restart",
                    "service": "postgres"
                },
                {
                    "type": "service_status",
                    "name": "Check Redis After Restart",
                    "service": "redis"
                },
                {
                    "type": "service_status",
                    "name": "Check App After Restart",
                    "service": "app"
                }
            ]
        },
        {
            "name": "Network Test",
            "description": "Проверка сетевых соединений",
            "actions": [
                {
                    "type": "command",
                    "name": "Check PostgreSQL Connection",
                    "command": "nc -zv localhost 5432"
                },
                {
                    "type": "command",
                    "name": "Check Redis Connection",
                    "command": "nc -zv localhost 6379"
                }
            ],
            "checks": [
                {
                    "type": "command",
                    "name": "Check App Health",
                    "command": "curl -s http://localhost:8000/health"
                }
            ]
        },
        {
            "name": "Data Persistence Test",
            "description": "Проверка сохранности данных",
            "actions": [
                {
                    "type": "command",
                    "name": "Test Redis Data",
                    "command": "docker exec vera-redis redis-cli SET test_key test_value"
                },
                {
                    "type": "command",
                    "name": "Test PostgreSQL Data",
                    "command": "docker exec vera-postgres psql -U postgres -c 'CREATE TABLE IF NOT EXISTS test_table (id SERIAL PRIMARY KEY, value TEXT);'"
                }
            ],
            "checks": [
                {
                    "type": "command",
                    "name": "Check Redis Data",
                    "command": "docker exec vera-redis redis-cli GET test_key"
                },
                {
                    "type": "command",
                    "name": "Check PostgreSQL Data",
                    "command": "docker exec vera-postgres psql -U postgres -c 'SELECT * FROM test_table;'"
                }
            ]
        },
        {
            "name": "Auto Recovery Test",
            "description": "Тестирование автоматического восстановления",
            "actions": [
                {
                    "type": "command",
                    "name": "Stop PostgreSQL",
                    "command": "docker stop vera-postgres"
                },
                {
                    "type": "sleep",
                    "name": "Wait for recovery",
                    "duration": 30
                }
            ],
            "checks": [
                {
                    "type": "service_status",
                    "name": "Check PostgreSQL Recovery",
                    "service": "postgres"
                },
                {
                    "type": "command",
                    "name": "Check PostgreSQL Data",
                    "command": "docker exec vera-postgres psql -U postgres -c 'SELECT * FROM test_table;'"
                }
            ]
        }
    ]
}
