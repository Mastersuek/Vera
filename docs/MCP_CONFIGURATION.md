# Настройка MCP (Model Control Plane) GitHub

## Оглавление
- [Введение](#введение)
- [Необходимые секреты и переменные](#необходимые-секреты-и-переменные)
- [Настройка вебхуков](#настройка-вебхуков)
- [Интеграция с внешними сервисами](#интеграция-с-внешними-сервисами)
- [Устранение неполадок](#устранение-неполадок)

## Введение

MCP (Model Control Plane) - это система управления задачами машинного обучения в проекте Vera. Данный документ описывает настройку интеграции MCP с GitHub.

## Необходимые секреты и переменные

### Секреты репозитория (Settings -> Secrets and variables -> Actions)

| Имя | Описание | Обязательно |
|-----|----------|-------------|
| `MCP_API_KEY` | Ключ API для доступа к MCP | Да |
| `SLACK_WEBHOOK_URL` | URL вебхука Slack для уведомлений | Нет |
| `DOCKERHUB_TOKEN` | Токен для доступа к Docker Hub | Да |
| `DOCKERHUB_USERNAME` | Имя пользователя Docker Hub | Да |
| `SSH_PRIVATE_KEY` | Приватный ключ для доступа к серверам | Да |
| `DB_PASSWORD` | Пароль базы данных | Да |

### Переменные репозитория (Settings -> Secrets and variables -> Variables)

| Имя | Описание | Значение по умолчанию |
|-----|----------|----------------------|
| `ENVIRONMENT` | Окружение (dev/stage/prod) | `dev` |
| `DOCKER_IMAGE` | Имя Docker-образа | `vera/vera-core` |
| `MCP_API_URL` | Базовый URL MCP API | `https://api.vera.example.com` |
| `MAX_WORKERS` | Максимальное количество воркеров | `4` |

## Настройка вебхуков

### GitHub Webhook

1. Перейдите в настройки репозитория -> Webhooks -> Add webhook
2. Настройки:
   - Payload URL: `https://api.vera.example.com/github/webhook`
   - Content type: `application/json`
   - Secret: [сгенерируйте и сохраните секретный ключ]
   - События:
     - Push
     - Pull request
     - Workflow run

### Slack Webhook

1. Создайте входящий вебхук в Slack (Slack App Directory -> Incoming WebHooks)
2. Добавьте URL вебхука в секреты репозитория как `SLACK_WEBHOOK_URL`

## Интеграция с внешними сервисами

### Docker Hub

1. Автоматическая сборка и публикация образов
2. Аутентификация через `DOCKERHUB_TOKEN` и `DOCKERHUB_USERNAME`

### Мониторинг (Prometheus/Grafana)

1. Настройте Prometheus для сбора метрик
2. Добавьте job в конфигурацию Prometheus:
   ```yaml
   - job_name: 'github_actions'
     metrics_path: '/metrics'
     static_configs:
       - targets: ['github-actions-exporter:9999']
   ```

## Устранение неполадок

### Проверка логов

1. GitHub Actions: Последние запуски в разделе Actions
2. MCP логи: `docker-compose logs mcp`

### Частые проблемы

1. **Ошибка аутентификации**
   - Проверьте правильность `MCP_API_KEY`
   - Убедитесь, что у ключа есть необходимые права

2. **Ошибки подключения к базе данных**
   - Проверьте `DB_PASSWORD` и настройки подключения
   - Убедитесь, что БД доступна из контейнера

3. **Проблемы с вебхуками**
   - Проверьте URL и секретный ключ
   - Убедитесь, что эндпоинт доступен извне

## Дополнительные настройки

### Ограничение доступа

Рекомендуется настроить ограничение доступа к репозиторию:
1. Требуйте проверки кода перед слиянием
2. Ограничьте права на запись в ветку `main`
3. Настройте обязательные проверки статуса

### Уведомления

Настройте уведомления в Slack о:
- Неудачных сборках
- Успешном деплое
- Критических ошибках

---

*Последнее обновление: 25.06.2025*
